matrix:
  fast_finish: true

# Test with the latest two releases of MSVC
configuration:
  - 2015
  - 2013

# Test with the latest Lua and LuaJIT versions
environment:
  LUAROCKS_VER: 2.3.0
  matrix:
  - LUA_VER: 5.3.2
    NOCOMPAT: true  # with compatibility flags disabled.
  - LJ_VER: 2.1

platform:
  - x86
  - x64

cache:
  - c:\lua -> appveyor.yml
  - c:\external -> appveyor.yml

install:
  - git submodule update --init
  - call .ci\set_compiler_env.bat
  - call .ci\install.bat
  - luarocks make

build_script:
  - msvcbuild.bat

test_script:
  - luajit.exe tests\run.lua
  - ps: if("$(Get-Location)" -eq $(lua -e "print(require'luv'.cwd())")) { "LuaRocks smoke test OK" } else { "LuaRocks smoke test failed" }

after_test:
  - luarocks remove luv

artifacts:
  - path: luv.dll
  - path: luajit.exe
